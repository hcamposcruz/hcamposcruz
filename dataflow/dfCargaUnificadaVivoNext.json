{
	"name": "dfCargaUnificadaVivoNext",
	"properties": {
		"folder": {
			"name": "VivoNext"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "connExecQry",
						"type": "DatasetReference"
					},
					"name": "TabelasVivoNext"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "CVTB_CONTESTACAO",
						"type": "DatasetReference"
					},
					"name": "TabelaCONTESTACAO"
				}
			],
			"transformations": [
				{
					"name": "AdaptaColunas"
				}
			],
			"script": "parameters{\n\tpLote as string,\n\tpMesAnoRef as string\n}\nsource(output(\n\t\tdt_emissao_fatura_2 as timestamp,\n\t\tnota_fiscal as string,\n\t\tdt_emissao_nfst as timestamp,\n\t\tvl_orig_nfst as decimal(15,2),\n\t\tserie as string,\n\t\tconta_cliente as string,\n\t\tcnpj_cpf as string,\n\t\tnome_cliente as string,\n\t\tterminal as string,\n\t\tvl_contest_ajuste as decimal(15,2),\n\t\tvl_alocado as decimal(38,2),\n\t\tdt_alocacao as timestamp,\n\t\thr_alocacao as string,\n\t\tdt_ajuste as timestamp,\n\t\thr_ajuste as string,\n\t\toperadora as string,\n\t\tcd_operadora as string,\n\t\tcd_motivo_ajuste as string,\n\t\tds_motivo_ajuste as string,\n\t\tnumero_fatura as string,\n\t\tfatu_alocada as string,\n\t\tdt_emissao_fatura as timestamp,\n\t\tmesanofatura as string,\n\t\tvl_docto_original as decimal(15,2),\n\t\tsaldo_devido_orig as decimal(15,2),\n\t\tsaldo_devedor as decimal(15,2),\n\t\tconta_contabil as string,\n\t\tds_conta_contabil as string,\n\t\tvl_fatura as decimal(15,2),\n\t\tcd_tipo_recebiveis as string,\n\t\tds_tipo_recebiveis as string,\n\t\tdebit_id as string,\n\t\tcredit_id as string,\n\t\tdt_pagamento as timestamp,\n\t\tuf as string,\n\t\tvl_pgto_alocado as decimal(15,2),\n\t\tvl_total_pagamento as decimal(15,2)\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: (\"SELECT k16.dt_emissao_fatura_2,k16.nota_fiscal,k16.dt_emissao_nfst,k16.vl_orig_nfst,k16.serie,k16.conta_cliente,k16.cnpj_cpf,k16.nome_cliente,k16.terminal,k16.vl_contest_ajuste,k16.vl_alocado,k16.dt_alocacao,k16.hr_alocacao,k16.dt_ajuste, k16.hr_ajuste,   k16.operadora,k16.cd_operadora,k16.cd_motivo_ajuste,k16.ds_motivo_ajuste,k16.numero_fatura,k16.fatu_alocada, k16.dt_emissao_fatura,k16.mesanofatura,k16.vl_docto_original,k17.saldo_devido_orig,k16.saldo_devedor,k16.conta_contabil,    k16.ds_conta_contabil,k16.vl_fatura,k16.cd_tipo_recebiveis,k16.ds_tipo_recebiveis,k16.debit_id,k17.credit_id,k17.dt_pagamento,    k16.uf,k17.vl_pgto_alocado,k17.vl_total_pagamento FROM [CONVENIO].[CVVW_VIVO_NEXT_K16_SUM] K16,      [CONVENIO].[CVVW_VIVO_NEXT_K17_UNIC] K17 WHERE K16.CONTA_CLIENTE = K17.CONTA_CLIENTE AND K16.CNPJ_CPF = K17.CNPJ_CPF AND K16.FATU_ALOCADA = K17.FATU_ALOCADA AND K16.MESANOFATURA = K17.MESANOFATURA AND K16.DEBIT_ID = K17.DEBIT_ID AND K16.CREDIT_ID = K17.CREDIT_ID AND K16.ID_LOTE_ARQUIVO IN (SELECT ID_LOTE_ARQUIVO FROM CONVENIO.CVTB_LOTE_ARQUIVO WITH (NOLOCK) WHERE ID_LOTE = {$pLote}) AND K17.ID_LOTE_ARQUIVO IN (SELECT ID_LOTE_ARQUIVO FROM CONVENIO.CVTB_LOTE_ARQUIVO WITH (NOLOCK) WHERE id_lote = {$pLote})\"),\n\tformat: 'query') ~> TabelasVivoNext\nTabelasVivoNext derive(id_lote_ajuste = $pLote,\n\t\tnome_billing = 'Vivonext',\n\t\tnum_controle_reclamacao_normalizado = concat(trim(serie), '123'),\n\t\tcd_criado_por = 'Carga ADF - CargaArqVivoNext',\n\t\tdt_criado_em = add(currentTimestamp(), hours(-3)),\n\t\tfl_status_geral = 'NT',\n\t\tMES_ANO_REF_ARQ = $pMesAnoRef,\n\t\tNOTA_FISCAL_ORIG_NORMALIZADO = nota_fiscal) ~> AdaptaColunas\nAdaptaColunas sink(allowSchemaDrift: false,\n\tvalidateSchema: false,\n\tinput(\n\t\tID_CONTESTACAO as decimal(28,0),\n\t\tID_CLIENTE as string,\n\t\tNOTA_FISCAL_ORIG as string,\n\t\tDT_EMISSAO_NF_ORIG as timestamp,\n\t\tVLR_ORIG_NSFT as decimal(15,2),\n\t\tSERIE_NF as string,\n\t\tCOD_IDENT_CLI as string,\n\t\tCPF_CNPJ as string,\n\t\tNOME_CLIENTE as string,\n\t\tTERMINAL as string,\n\t\tVLR_TOTAL_ATRIBUIDO as decimal(15,2),\n\t\tVLR_ATRIBUIDO as decimal(15,2),\n\t\tDT_ATRIBUICAO as timestamp,\n\t\tDT_AJUSTE as timestamp,\n\t\tDESCR_OPERADORA as string,\n\t\tCOD_OPERADORA as string,\n\t\tCOD_MOTIVO_AJUSTE as string,\n\t\tDESC_MOTIVO_AJUSTE as string,\n\t\tNUM_CONTROLE_RECLAMACAO as string,\n\t\tCLASSE_RECEBER as string,\n\t\tCONTA_FINANCEIRA as string,\n\t\tDESC_CONTA_FINANCEIRA as string,\n\t\tNUM_FATURA_ORIGINAL as string,\n\t\tVLR_DOC_ORIGINAL as decimal(15,2),\n\t\tFATURA_ATRIBUIDA as string,\n\t\tVLR_FATURA as decimal(15,2),\n\t\tUF_FATURA as string,\n\t\tSEQ_RECEBIVEL as string,\n\t\tDT_EMISSAO as timestamp,\n\t\tMODELO as string,\n\t\tNUMORDEMDOITEM as decimal(3,0),\n\t\tBC_ICMS as decimal(15,2),\n\t\tICMS as decimal(15,2),\n\t\tALIQUOTA_ICMS as decimal(15,2),\n\t\tBC_ICMS_RECALCULADA as decimal(15,2),\n\t\tICMS_RECALCULADO as decimal(15,2),\n\t\tICMS_PARA_RESSARCIMENTO as decimal(15,2),\n\t\tSITUACAO as string,\n\t\tMES_APURACAO as string,\n\t\tTIPO_DOC as decimal(1,0),\n\t\tCOD_CONSUMIDOR as string,\n\t\tCHAVE_AUTENTICACAO as string,\n\t\tTOTAL_MESTRE as decimal(15,2),\n\t\tBC_ICMS_MESTRE as decimal(15,2),\n\t\tICMS_DESTACADO as decimal(15,2),\n\t\tINSCRICAO_ESTADUAL as string,\n\t\tRAZAO_SOCIAL as string,\n\t\tFL_STATUS_GERAL as string,\n\t\tID_LOTE_AJUSTE as decimal(28,0),\n\t\tID_ENTREGA_RESSARCIMENTO as decimal(28,0),\n\t\tCD_ITEM as string,\n\t\tDS_ITEM as string,\n\t\tHR_AJUSTE as string,\n\t\tHR_ATRIBUICAO as string,\n\t\tNOME_BILLING as string,\n\t\tTIPO_CLIENTE as string,\n\t\tDT_ABERTURA_IMPUG as timestamp,\n\t\tDT_FECHA_IMPUG as timestamp,\n\t\tSALDO_DEVEDOR as decimal(15,2),\n\t\tSALDO_FATURA_INI as decimal(15,2),\n\t\tSALDO_FATURA_FIM as decimal(15,2),\n\t\tCOD_CLIENTE as string,\n\t\tTIPO_DOCUMENTO as string,\n\t\tNOME_FANTASIA as string,\n\t\tCOD_GRUPO as string,\n\t\tNOME_GRUPO_ECONOMICO as string,\n\t\tSEGMENTO_CLIENTE as string,\n\t\tSUB_SEGMENTO_CLIENTE as string,\n\t\tSEGMENTO_VALOR as string,\n\t\tCLASSE_ELEGIBILIDADE as string,\n\t\tDESCR_SERV_AJUSTE as string,\n\t\tDESCR_SERV as string,\n\t\tCONTACONTABIL_DB as string,\n\t\tCONTACONTABIL_CR as string,\n\t\tDESCR_CONTACONTABIL_DB as string,\n\t\tDESCR_CONTACONTABIL_CR as string,\n\t\tSALDO_POS_AJUSTE as decimal(15,2),\n\t\tTIPO_OPERACAO as string,\n\t\tTIPO_TERMINAL as string,\n\t\tDONO_RECEITA as string,\n\t\tSUBTYPE_CODE as decimal(19,0),\n\t\tTIPO_DESCR_SERV as string,\n\t\tDT_VENCTO_FAT_FUTURA as timestamp,\n\t\tVLR_IMPOSTO_CONTESTADO as decimal(15,2),\n\t\tVLR_IMPOSTO_ICMS as decimal(15,2),\n\t\tVLR_BRUTO_ITEM as decimal(15,2),\n\t\tVLR_OUTROS_IMPOSTOS as decimal(15,2),\n\t\tVLR_AJUSTE_ITEM as decimal(15,2),\n\t\tVLR_CREDITO_AJUSTE as decimal(15,2),\n\t\tVLR_CREDITO_ITEM as decimal(15,2),\n\t\tVLR_DEVOLUCAO as decimal(15,2),\n\t\tVLR_FATURA_FUTURA as decimal(15,2),\n\t\tVLR_CONTESTADO_FUTURO as decimal(15,2),\n\t\tLOGIN_ATENDIMENTO as string,\n\t\tDT_VENC_FATURA_ORIGINAL as timestamp,\n\t\tDT_ATRIBUICAO_PGTO as timestamp,\n\t\tNUM_ITEM_ESTORNADO as decimal(10,0),\n\t\tFLG_RETIFICADO as string,\n\t\tTERMINAL_115 as string,\n\t\tVALOR_ITEM_115 as decimal(15,2),\n\t\tDT_CRIADO_EM as timestamp,\n\t\tCD_CRIADO_POR as string,\n\t\tDT_ATUALIZADO_EM as timestamp,\n\t\tCD_ATUALIZADO_POR as string,\n\t\tMES_ANO_FAT_ORIGINAL as string,\n\t\tMES_ANO_FAT_AJUSTE as string,\n\t\tVLR_PAGAMENTO_FAT_ORIGINAL as decimal(15,2),\n\t\tID_ITEM_CONVENIO_115 as decimal(28,0),\n\t\tNUM_CONTROLE_RECLAMACAO_NORMALIZADO as string,\n\t\tNOTA_FISCAL_ORIG_NORMALIZADO as string,\n\t\tCOD_FAC_CD as decimal(10,0),\n\t\tCCM_SERVICO_CONTESTADO as string,\n\t\tCOD_TIPO_RCBL_FATURA as string,\n\t\tDESCR_RCBL_FATURA as string,\n\t\tDT_PAGAMENTO as timestamp,\n\t\tDEBIT_ID as string,\n\t\tDT_EMISSAO_FATURA_ORIGINAL as timestamp,\n\t\tUF_NF as string,\n\t\tVLR_PGTO_ALOCADO as decimal(15,2),\n\t\tVLR_TOTAL_PGTO as decimal(15,2),\n\t\tCREDIT_ID as string,\n\t\tDT_REFERENCIA as timestamp,\n\t\tDT_IMPORTACAO as timestamp,\n\t\tSTEP_EXECUTION_ID as decimal(18,0),\n\t\tJOB_EXECUTION_ID as decimal(18,0),\n\t\tID_MESTRE_CONVENIO_115 as decimal(28,0),\n\t\tFL_MANUAL_CONCILIACAO as string,\n\t\tDT_CONCILIACAO as timestamp,\n\t\tDT_EMISSAO_115 as timestamp,\n\t\tMES_ANO_REF_ARQ as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tNOTA_FISCAL_ORIG = nota_fiscal,\n\t\tDT_EMISSAO_NF_ORIG = dt_emissao_nfst,\n\t\tVLR_ORIG_NSFT = vl_orig_nfst,\n\t\tSERIE_NF = serie,\n\t\tCOD_IDENT_CLI = conta_cliente,\n\t\tCPF_CNPJ = cnpj_cpf,\n\t\tNOME_CLIENTE = nome_cliente,\n\t\tTERMINAL = terminal,\n\t\tVLR_TOTAL_ATRIBUIDO = vl_contest_ajuste,\n\t\tVLR_ATRIBUIDO = vl_alocado,\n\t\tDT_ATRIBUICAO = dt_alocacao,\n\t\tDT_AJUSTE = dt_ajuste,\n\t\tDESCR_OPERADORA = operadora,\n\t\tCOD_OPERADORA = cd_operadora,\n\t\tCOD_MOTIVO_AJUSTE = cd_motivo_ajuste,\n\t\tDESC_MOTIVO_AJUSTE = ds_motivo_ajuste,\n\t\tNUM_FATURA_ORIGINAL = numero_fatura,\n\t\tVLR_DOC_ORIGINAL = vl_docto_original,\n\t\tFATURA_ATRIBUIDA = fatu_alocada,\n\t\tDT_EMISSAO = dt_emissao_fatura_2,\n\t\tFL_STATUS_GERAL = fl_status_geral,\n\t\tID_LOTE_AJUSTE = id_lote_ajuste,\n\t\tHR_AJUSTE = hr_ajuste,\n\t\tHR_ATRIBUICAO = hr_alocacao,\n\t\tNOME_BILLING = nome_billing,\n\t\tSALDO_FATURA_FIM = saldo_devedor,\n\t\tCONTACONTABIL_DB = conta_contabil,\n\t\tDESCR_CONTACONTABIL_DB = ds_conta_contabil,\n\t\tVLR_FATURA_FUTURA = vl_fatura,\n\t\tDT_CRIADO_EM = dt_criado_em,\n\t\tCD_CRIADO_POR = cd_criado_por,\n\t\tMES_ANO_FAT_AJUSTE = mesanofatura,\n\t\tNUM_CONTROLE_RECLAMACAO_NORMALIZADO = num_controle_reclamacao_normalizado,\n\t\tCOD_TIPO_RCBL_FATURA = cd_tipo_recebiveis,\n\t\tDESCR_RCBL_FATURA = ds_tipo_recebiveis,\n\t\tDT_PAGAMENTO = dt_pagamento,\n\t\tDEBIT_ID = debit_id,\n\t\tDT_EMISSAO_FATURA_ORIGINAL = dt_emissao_fatura,\n\t\tUF_NF = uf,\n\t\tCREDIT_ID = credit_id,\n\t\tMES_ANO_REF_ARQ,\n\t\tNOME_BILLING = nome_billing,\n\t\tNOTA_FISCAL_ORIG_NORMALIZADO\n\t)) ~> TabelaCONTESTACAO"
		}
	}
}