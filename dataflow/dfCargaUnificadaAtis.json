{
	"name": "dfCargaUnificadaAtis",
	"properties": {
		"folder": {
			"name": "Atis"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "connExecQry",
						"type": "DatasetReference"
					},
					"name": "TabelaAtis"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "CVTB_CONTESTACAO",
						"type": "DatasetReference"
					},
					"name": "TabelaCONTESTACAO"
				}
			],
			"transformations": [
				{
					"name": "AdaptaColunas"
				}
			],
			"script": "parameters{\n\tpLote as string,\n\tpMesAnoRef as string\n}\nsource(output(\n\t\tNOTA_FISCAL_ORIG as string,\n\t\tVLR_ORIG_NSFT as decimal(15,2),\n\t\tSERIE_NF as string,\n\t\tdescr_operadora as string,\n\t\tCOD_IDENT_CLI as string,\n\t\tCPF_CNPJ as string,\n\t\tVLR_ATRIBUIDO as decimal(15,2),\n\t\tDT_ATRIBUICAO as timestamp,\n\t\tDT_AJUSTE as timestamp,\n\t\tCOD_MOTIVO_AJUSTE as string,\n\t\tDT_ABERTURA_IMPUG as timestamp,\n\t\tNUM_FATURA_ORIGINAL as string,\n\t\tDT_VENC_FATURA_ORIGINAL as timestamp,\n\t\tDT_EMISSAO_FATURA as timestamp,\n\t\tVLR_FATURA as decimal(15,2),\n\t\tSALDO_DEVEDOR as decimal(15,2),\n\t\tUF_FATURA as string,\n\t\tTIPO_DOCUMENTO as string,\n\t\tCONTACONTABIL_CR as string,\n\t\tCONTACONTABIL_DB as string,\n\t\tDESCR_CONTACONTABIL_DB as string,\n\t\tDESCR_CONTACONTABIL_CR as string,\n\t\tSALDO_POS_AJUSTE as decimal(15,2),\n\t\tTIPO_OPERACAO as string,\n\t\tDT_VENCTO_FAT_FUTURA as timestamp,\n\t\tVLR_AJUSTE_ITEM as decimal(15,2),\n\t\tVLR_CREDITO_AJUSTE as decimal(15,2),\n\t\tVLR_DEVOLUCAO as decimal(15,2),\n\t\tVLR_FATURA_FUTURA as decimal(15,2),\n\t\tCOD_FAC_CD as decimal(10,0),\n\t\tCOD_OPERADORA as string,\n\t\treceita_operadora as string,\n\t\tCOD_CREDITO as decimal(10,2),\n\t\tNUM_FATURA_FUTURA as string\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: (\"SELECT np.nota_fiscal_orig AS NOTA_FISCAL_ORIG, np.vlr_orig_nsft AS VLR_ORIG_NSFT, np.serie_nf AS SERIE_NF, np.descr_operadora,np.cod_ident_cli AS COD_IDENT_CLI,np.cpf_cnpj\tAS CPF_CNPJ,np.vlr_contestado AS VLR_ATRIBUIDO,np.dt_vencto_boleto_ult AS DT_ATRIBUICAO,np.dt_ajuste AS\tDT_AJUSTE,np.cod_motivo_ajuste AS COD_MOTIVO_AJUSTE,np.dt_abertura_impug AS\tDT_ABERTURA_IMPUG,np.num_fatura_original AS NUM_FATURA_ORIGINAL,np.dt_venc_fatura_original AS DT_VENC_FATURA_ORIGINAL, np.dt_emissao_fatura AS\tDT_EMISSAO_FATURA,np.vlr_fatura AS VLR_FATURA,np.saldo_devedor AS SALDO_DEVEDOR,np.uf_fatura AS UF_FATURA,CASE WHEN np.tipo_documento = 'PF' THEN 'CPF' WHEN np.tipo_documento = 'PJ' THEN 'CNPJ' ELSE NULL END AS TIPO_DOCUMENTO,np.contacontabil AS CONTACONTABIL_CR,np.contacontabil AS CONTACONTABIL_DB,np.descrcontacontabil AS DESCR_CONTACONTABIL_DB,np.descrcontacontabil AS DESCR_CONTACONTABIL_CR,np.saldo_pos_ajuste AS SALDO_POS_AJUSTE,np.tipo_operacao AS\tTIPO_OPERACAO,np.dt_venc_fatura_original AS DT_VENCTO_FAT_FUTURA,NULL AS\tVLR_AJUSTE_ITEM, NULL AS VLR_CREDITO_AJUSTE, NULL AS VLR_DEVOLUCAO,NULL AS\tVLR_FATURA_FUTURA,np.cod_fac_cd AS COD_FAC_CD,np.cod_operadora AS COD_OPERADORA, np.receita_operadora, null AS COD_CREDITO,null AS NUM_FATURA_FUTURA FROM convenio.cvtb_atis_nao_pago np WITH (NOLOCK)  WHERE id_lote_arquivo IN (SELECT id_lote_arquivo FROM CONVENIO.CVTB_LOTE_ARQUIVO WITH (NOLOCK)  WHERE ID_LOTE = {$pLote}) UNION ALL SELECT  ap.nota_fiscal_orig AS NOTA_FISCAL_ORIG,ap.vlr_orig_nsft AS VLR_ORIG_NSFT, ap.serie_nf AS SERIE_NF, ap.descr_operadora AS DESCR_OPERADORA, ap.cod_ident_cli AS COD_IDENT_CLI,ap.cpf_cnpj\tAS CPF_CNPJ,ap.vlr_credito_item AS\tVLR_ATRIBUIDO,ap.dt_vencto_boleto_ult AS DT_ATRIBUICAO,ap.dt_ajuste AS\tDT_AJUSTE,ap.cod_motivo_ajuste AS\tCOD_MOTIVO_AJUSTE, ap.dt_abertura_impug AS\tDT_ABERTURA_IMPUG,ap.num_fatura_original AS\tNUM_FATURA_ORIGINAL,ap.dt_venc_fatura_original AS\tDT_VENC_FATURA_ORIGINAL,ap.dt_emissao_fatura AS DT_EMISSAO_FATURA,ap.vlr_fatura AS\tVLR_FATURA,ap.saldo_devedor AS\tSALDO_DEVEDOR,ap.uf_fatura AS UF_FATURA,CASE WHEN ap.tipo_documento = 'PF' THEN 'CPF' WHEN ap.tipo_documento = 'PJ' THEN 'CNPJ' ELSE NULL END AS TIPO_DOCUMENTO,ap.contacontabil AS CONTACONTABIL_CR,ap.contacontabil AS CONTACONTABIL_DB, ap.descrcontacontabil AS DESCR_CONTACONTABIL_DB ,ap.descrcontacontabil AS DESCR_CONTACONTABIL_CR,ap.saldo_pos_ajuste\tAS SALDO_POS_AJUSTE,ap.tipo_operacao AS\tTIPO_OPERACAO,ap.dt_venc_fatura_original AS DT_VENCTO_FAT_FUTURA,ap.vlr_ajuste_item AS\tVLR_AJUSTE_ITEM,ap.vlr_credito_ajuste AS VALOR_CREDITO_AJUSTE,ap.vlr_devolucao AS\tVLR_DEVOLUCAO,ap.vlr_fatura_futura AS VLR_FATURA_FUTURA,ap.cod_fac_cd AS COD_FAC_CD,ap.cod_operadora AS\tCOD_OPERADORA,ap.receita_operadora, ap.cod_credito, ap.num_fatura_futura FROM convenio.cvtb_atis_pago ap WITH (NOLOCK)  WHERE id_lote_arquivo IN (SELECT id_lote_arquivo FROM CONVENIO.CVTB_LOTE_ARQUIVO WITH (NOLOCK)  WHERE ID_LOTE = {$pLote})\"\r),\n\tformat: 'query') ~> TabelaAtis\nTabelaAtis derive(id_lote_ajuste = $pLote,\n\t\tnome_billing = 'Atis',\n\t\tnota_fiscal_orig_normalizado = replace(trim(NOTA_FISCAL_ORIG), right(NOTA_FISCAL_ORIG, 4), ''),\n\t\tnum_controle_reclamacao_normalizado = concat(trim(SERIE_NF), '123'),\n\t\tcd_criado_por = 'Carga ADF - CargaArqAtis',\n\t\tdt_criado_em = add(currentTimestamp(), hours(-3)),\n\t\tfl_status_geral = 'NT',\n\t\tMES_ANO_REF_ARQ = concat(right($pMesAnoRef, 2), left($pMesAnoRef, 4)),\n\t\tNUM_ITEM_ESTORNADO = toDecimal(COD_CREDITO, 2)) ~> AdaptaColunas\nAdaptaColunas sink(allowSchemaDrift: false,\n\tvalidateSchema: false,\n\tinput(\n\t\tID_CONTESTACAO as decimal(28,0),\n\t\tID_CLIENTE as string,\n\t\tNOTA_FISCAL_ORIG as string,\n\t\tDT_EMISSAO_NF_ORIG as timestamp,\n\t\tVLR_ORIG_NSFT as decimal(15,2),\n\t\tSERIE_NF as string,\n\t\tCOD_IDENT_CLI as string,\n\t\tCPF_CNPJ as string,\n\t\tNOME_CLIENTE as string,\n\t\tTERMINAL as string,\n\t\tVLR_TOTAL_ATRIBUIDO as decimal(15,2),\n\t\tVLR_ATRIBUIDO as decimal(15,2),\n\t\tDT_ATRIBUICAO as timestamp,\n\t\tDT_AJUSTE as timestamp,\n\t\tDESCR_OPERADORA as string,\n\t\tCOD_OPERADORA as string,\n\t\tCOD_MOTIVO_AJUSTE as string,\n\t\tDESC_MOTIVO_AJUSTE as string,\n\t\tNUM_CONTROLE_RECLAMACAO as string,\n\t\tCLASSE_RECEBER as string,\n\t\tCONTA_FINANCEIRA as string,\n\t\tDESC_CONTA_FINANCEIRA as string,\n\t\tNUM_FATURA_ORIGINAL as string,\n\t\tVLR_DOC_ORIGINAL as decimal(15,2),\n\t\tFATURA_ATRIBUIDA as string,\n\t\tVLR_FATURA as decimal(15,2),\n\t\tUF_FATURA as string,\n\t\tSEQ_RECEBIVEL as string,\n\t\tDT_EMISSAO as timestamp,\n\t\tMODELO as string,\n\t\tNUMORDEMDOITEM as decimal(3,0),\n\t\tBC_ICMS as decimal(15,2),\n\t\tICMS as decimal(15,2),\n\t\tALIQUOTA_ICMS as decimal(15,2),\n\t\tBC_ICMS_RECALCULADA as decimal(15,2),\n\t\tICMS_RECALCULADO as decimal(15,2),\n\t\tICMS_PARA_RESSARCIMENTO as decimal(15,2),\n\t\tSITUACAO as string,\n\t\tMES_APURACAO as string,\n\t\tTIPO_DOC as decimal(1,0),\n\t\tCOD_CONSUMIDOR as string,\n\t\tCHAVE_AUTENTICACAO as string,\n\t\tTOTAL_MESTRE as decimal(15,2),\n\t\tBC_ICMS_MESTRE as decimal(15,2),\n\t\tICMS_DESTACADO as decimal(15,2),\n\t\tINSCRICAO_ESTADUAL as string,\n\t\tRAZAO_SOCIAL as string,\n\t\tFL_STATUS_GERAL as string,\n\t\tID_LOTE_AJUSTE as decimal(28,0),\n\t\tID_ENTREGA_RESSARCIMENTO as decimal(28,0),\n\t\tCD_ITEM as string,\n\t\tDS_ITEM as string,\n\t\tHR_AJUSTE as string,\n\t\tHR_ATRIBUICAO as string,\n\t\tNOME_BILLING as string,\n\t\tTIPO_CLIENTE as string,\n\t\tDT_ABERTURA_IMPUG as timestamp,\n\t\tDT_FECHA_IMPUG as timestamp,\n\t\tSALDO_DEVEDOR as decimal(15,2),\n\t\tSALDO_FATURA_INI as decimal(15,2),\n\t\tSALDO_FATURA_FIM as decimal(15,2),\n\t\tCOD_CLIENTE as string,\n\t\tTIPO_DOCUMENTO as string,\n\t\tNOME_FANTASIA as string,\n\t\tCOD_GRUPO as string,\n\t\tNOME_GRUPO_ECONOMICO as string,\n\t\tSEGMENTO_CLIENTE as string,\n\t\tSUB_SEGMENTO_CLIENTE as string,\n\t\tSEGMENTO_VALOR as string,\n\t\tCLASSE_ELEGIBILIDADE as string,\n\t\tDESCR_SERV_AJUSTE as string,\n\t\tDESCR_SERV as string,\n\t\tCONTACONTABIL_DB as string,\n\t\tCONTACONTABIL_CR as string,\n\t\tDESCR_CONTACONTABIL_DB as string,\n\t\tDESCR_CONTACONTABIL_CR as string,\n\t\tSALDO_POS_AJUSTE as decimal(15,2),\n\t\tTIPO_OPERACAO as string,\n\t\tTIPO_TERMINAL as string,\n\t\tDONO_RECEITA as string,\n\t\tSUBTYPE_CODE as decimal(19,0),\n\t\tTIPO_DESCR_SERV as string,\n\t\tDT_VENCTO_FAT_FUTURA as timestamp,\n\t\tVLR_IMPOSTO_CONTESTADO as decimal(15,2),\n\t\tVLR_IMPOSTO_ICMS as decimal(15,2),\n\t\tVLR_BRUTO_ITEM as decimal(15,2),\n\t\tVLR_OUTROS_IMPOSTOS as decimal(15,2),\n\t\tVLR_AJUSTE_ITEM as decimal(15,2),\n\t\tVLR_CREDITO_AJUSTE as decimal(15,2),\n\t\tVLR_CREDITO_ITEM as decimal(15,2),\n\t\tVLR_DEVOLUCAO as decimal(15,2),\n\t\tVLR_FATURA_FUTURA as decimal(15,2),\n\t\tVLR_CONTESTADO_FUTURO as decimal(15,2),\n\t\tLOGIN_ATENDIMENTO as string,\n\t\tDT_VENC_FATURA_ORIGINAL as timestamp,\n\t\tDT_ATRIBUICAO_PGTO as timestamp,\n\t\tNUM_ITEM_ESTORNADO as decimal(10,0),\n\t\tFLG_RETIFICADO as string,\n\t\tTERMINAL_115 as string,\n\t\tVALOR_ITEM_115 as decimal(15,2),\n\t\tDT_CRIADO_EM as timestamp,\n\t\tCD_CRIADO_POR as string,\n\t\tDT_ATUALIZADO_EM as timestamp,\n\t\tCD_ATUALIZADO_POR as string,\n\t\tMES_ANO_FAT_ORIGINAL as string,\n\t\tMES_ANO_FAT_AJUSTE as string,\n\t\tVLR_PAGAMENTO_FAT_ORIGINAL as decimal(15,2),\n\t\tID_ITEM_CONVENIO_115 as decimal(28,0),\n\t\tNUM_CONTROLE_RECLAMACAO_NORMALIZADO as string,\n\t\tNOTA_FISCAL_ORIG_NORMALIZADO as string,\n\t\tCOD_FAC_CD as decimal(10,0),\n\t\tCCM_SERVICO_CONTESTADO as string,\n\t\tCOD_TIPO_RCBL_FATURA as string,\n\t\tDESCR_RCBL_FATURA as string,\n\t\tDT_PAGAMENTO as timestamp,\n\t\tDEBIT_ID as string,\n\t\tDT_EMISSAO_FATURA_ORIGINAL as timestamp,\n\t\tUF_NF as string,\n\t\tVLR_PGTO_ALOCADO as decimal(15,2),\n\t\tVLR_TOTAL_PGTO as decimal(15,2),\n\t\tCREDIT_ID as string,\n\t\tDT_REFERENCIA as timestamp,\n\t\tDT_IMPORTACAO as timestamp,\n\t\tSTEP_EXECUTION_ID as decimal(18,0),\n\t\tJOB_EXECUTION_ID as decimal(18,0),\n\t\tID_MESTRE_CONVENIO_115 as decimal(28,0),\n\t\tFL_MANUAL_CONCILIACAO as string,\n\t\tDT_CONCILIACAO as timestamp,\n\t\tDT_EMISSAO_115 as timestamp,\n\t\tMES_ANO_REF_ARQ as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tNOTA_FISCAL_ORIG,\n\t\tVLR_ORIG_NSFT,\n\t\tSERIE_NF,\n\t\tCOD_IDENT_CLI,\n\t\tCPF_CNPJ,\n\t\tVLR_ATRIBUIDO,\n\t\tDT_ATRIBUICAO,\n\t\tDT_AJUSTE,\n\t\tDESCR_OPERADORA = descr_operadora,\n\t\tCOD_OPERADORA,\n\t\tCOD_MOTIVO_AJUSTE,\n\t\tNUM_FATURA_ORIGINAL,\n\t\tDT_EMISSAO_FATURA_ORIGINAL = DT_EMISSAO_FATURA,\n\t\tVLR_FATURA,\n\t\tUF_FATURA,\n\t\tFL_STATUS_GERAL = fl_status_geral,\n\t\tID_LOTE_AJUSTE = id_lote_ajuste,\n\t\tNOME_BILLING = nome_billing,\n\t\tDT_ABERTURA_IMPUG,\n\t\tSALDO_DEVEDOR,\n\t\tTIPO_DOCUMENTO,\n\t\tCONTACONTABIL_DB,\n\t\tCONTACONTABIL_CR,\n\t\tDESCR_CONTACONTABIL_DB,\n\t\tDESCR_CONTACONTABIL_CR,\n\t\tSALDO_POS_AJUSTE,\n\t\tTIPO_OPERACAO,\n\t\tDT_VENCTO_FAT_FUTURA,\n\t\tVLR_AJUSTE_ITEM,\n\t\tVLR_CREDITO_AJUSTE,\n\t\tVLR_DEVOLUCAO,\n\t\tVLR_FATURA_FUTURA,\n\t\tDT_VENC_FATURA_ORIGINAL,\n\t\tDT_CRIADO_EM = dt_criado_em,\n\t\tCD_CRIADO_POR = cd_criado_por,\n\t\tNUM_CONTROLE_RECLAMACAO_NORMALIZADO = num_controle_reclamacao_normalizado,\n\t\tNOTA_FISCAL_ORIG_NORMALIZADO = nota_fiscal_orig_normalizado,\n\t\tCOD_FAC_CD,\n\t\tMES_ANO_REF_ARQ,\n\t\tDONO_RECEITA = receita_operadora,\n\t\tNUM_ITEM_ESTORNADO,\n\t\tFATURA_ATRIBUIDA = NUM_FATURA_FUTURA\n\t)) ~> TabelaCONTESTACAO"
		}
	}
}